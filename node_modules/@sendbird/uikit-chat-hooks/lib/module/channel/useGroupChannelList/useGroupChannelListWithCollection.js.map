{"version":3,"names":["useEffect","useRef","GroupChannelEventSource","GroupChannelFilter","GroupChannelListOrder","confirmAndMarkAsDelivered","useAsyncEffect","useFreshCallback","useUniqId","useAppFeatures","useChannelHandler","useGroupChannelListReducer","HOOK_NAME","createGroupChannelListCollection","sdk","collectionCreator","passedCollection","filter","includeEmpty","groupChannel","createGroupChannelCollection","limit","order","LATEST_LAST_MESSAGE","useGroupChannelListWithCollection","userId","options","id","deliveryReceiptEnabled","collectionRef","loading","groupChannels","refreshing","setChannels","deleteChannels","updateRefreshing","updateLoading","updateChannelsAndMarkAsDelivered","markAsDelivered","source","updatedChannels","channels","current","EVENT_MESSAGE_RECEIVED","EVENT_MESSAGE_SENT","SYNC_CHANNEL_BACKGROUND","SYNC_CHANNEL_CHANGELOGS","undefined","init","uid","dispose","setGroupChannelCollectionHandler","onChannelsAdded","context","onChannelsUpdated","onChannelsDeleted","hasMore","loadMore","onUserBanned","channel","user","isMe","url","refresh","next"],"sources":["useGroupChannelListWithCollection.ts"],"sourcesContent":["import { useEffect, useRef } from 'react';\n\nimport { GroupChannelEventSource, GroupChannelFilter, GroupChannelListOrder } from '@sendbird/chat/groupChannel';\nimport type { SendbirdBaseChannel, SendbirdChatSDK, SendbirdGroupChannelCollection } from '@sendbird/uikit-utils';\nimport { confirmAndMarkAsDelivered, useAsyncEffect, useFreshCallback, useUniqId } from '@sendbird/uikit-utils';\n\nimport { useAppFeatures } from '../../common/useAppFeatures';\nimport { useChannelHandler } from '../../handler/useChannelHandler';\nimport type { UseGroupChannelList, UseGroupChannelListOptions } from '../../types';\nimport { useGroupChannelListReducer } from './reducer';\n\nconst HOOK_NAME = 'useGroupChannelListWithCollection';\n\nconst createGroupChannelListCollection = (\n  sdk: SendbirdChatSDK,\n  collectionCreator: UseGroupChannelListOptions['collectionCreator'],\n) => {\n  const passedCollection = collectionCreator?.();\n  if (passedCollection) return passedCollection;\n\n  const filter = new GroupChannelFilter();\n  filter.includeEmpty = false;\n\n  return sdk.groupChannel.createGroupChannelCollection({\n    filter,\n    limit: 20,\n    order: GroupChannelListOrder.LATEST_LAST_MESSAGE,\n  });\n};\n\nexport const useGroupChannelListWithCollection: UseGroupChannelList = (sdk, userId, options) => {\n  const id = useUniqId(HOOK_NAME);\n  const { deliveryReceiptEnabled } = useAppFeatures(sdk);\n\n  const collectionRef = useRef<SendbirdGroupChannelCollection>();\n\n  const { loading, groupChannels, refreshing, setChannels, deleteChannels, updateRefreshing, updateLoading } =\n    useGroupChannelListReducer();\n\n  const updateChannelsAndMarkAsDelivered = (\n    markAsDelivered: boolean,\n    source?: GroupChannelEventSource,\n    updatedChannels?: SendbirdBaseChannel[],\n  ) => {\n    const channels = collectionRef.current?.channels ?? [];\n    setChannels(channels, true);\n    if (markAsDelivered && deliveryReceiptEnabled) {\n      switch (source) {\n        case GroupChannelEventSource.EVENT_MESSAGE_RECEIVED:\n        case GroupChannelEventSource.EVENT_MESSAGE_SENT:\n        case GroupChannelEventSource.SYNC_CHANNEL_BACKGROUND:\n        case GroupChannelEventSource.SYNC_CHANNEL_CHANGELOGS:\n        case undefined:\n          confirmAndMarkAsDelivered(updatedChannels ?? channels);\n          break;\n      }\n    }\n  };\n\n  const init = useFreshCallback(async (uid?: string) => {\n    if (collectionRef.current) collectionRef.current?.dispose();\n\n    if (uid) {\n      collectionRef.current = createGroupChannelListCollection(sdk, options?.collectionCreator);\n\n      collectionRef.current?.setGroupChannelCollectionHandler({\n        onChannelsAdded: (context, channels) => {\n          updateChannelsAndMarkAsDelivered(true, context.source, channels);\n        },\n        onChannelsUpdated: (context, channels) => {\n          updateChannelsAndMarkAsDelivered(true, context.source, channels);\n        },\n        onChannelsDeleted: () => {\n          updateChannelsAndMarkAsDelivered(false);\n        },\n      });\n\n      if (collectionRef.current?.hasMore) {\n        await collectionRef.current?.loadMore();\n        updateChannelsAndMarkAsDelivered(true);\n      }\n    }\n  });\n\n  useEffect(() => {\n    return () => {\n      if (collectionRef.current) collectionRef.current?.dispose();\n    };\n  }, []);\n\n  useAsyncEffect(async () => {\n    updateLoading(true);\n    await init(userId);\n    updateLoading(false);\n  }, [init, userId]);\n\n  useChannelHandler(sdk, `${HOOK_NAME}_${id}`, {\n    onUserBanned: (channel, user) => {\n      const isMe = user.userId === userId;\n      if (isMe) deleteChannels([channel.url]);\n      else updateChannelsAndMarkAsDelivered(false);\n    },\n  });\n\n  const refresh = useFreshCallback(async () => {\n    updateRefreshing(true);\n    await init(userId);\n    updateRefreshing(false);\n  });\n\n  const next = useFreshCallback(async () => {\n    if (collectionRef.current?.hasMore) {\n      await collectionRef.current?.loadMore();\n      updateChannelsAndMarkAsDelivered(true);\n    }\n  });\n\n  return {\n    loading,\n    groupChannels,\n    refresh,\n    refreshing,\n    next,\n  };\n};\n"],"mappings":"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"}