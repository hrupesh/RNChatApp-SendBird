{"version":3,"names":["createExpoFileService","imagePickerModule","documentPickerModule","mediaLibraryModule","fsModule","ExpoFileServiceInterface","hasCameraPermission","res","getCameraPermissionsAsync","expoPermissionGranted","requestCameraPermission","requestCameraPermissionsAsync","hasMediaLibraryPermission","type","perms","getPermissionsAsync","requestMediaLibraryPermission","requestPermissionsAsync","openCamera","options","hasPermission","granted","onOpenFailure","SBUError","PERMISSIONS_DENIED","response","launchCameraAsync","mediaTypes","mediaType","MediaTypeOptions","Images","Videos","All","cancelled","uri","size","getInfoAsync","ext","getFileExtension","getFileType","fileTypeGuard","slice","name","Date","now","openMediaLibrary","launchImageLibraryAsync","openDocument","getDocumentAsync","mimeType","e","UNKNOWN","save","Error","basePath","documentDirectory","cacheDirectory","downloadPath","fileName","downloadAsync","fileUrl","fileType","match","saveToLibraryAsync"],"sources":["createFileService.expo.ts"],"sourcesContent":["import type * as ExpoDocumentPicker from 'expo-document-picker';\nimport type * as ExpoFs from 'expo-file-system';\nimport type * as ExpoImagePicker from 'expo-image-picker';\nimport type * as ExpoMediaLibrary from 'expo-media-library';\n\nimport { getFileExtension, getFileType } from '@sendbird/uikit-utils';\n\nimport SBUError from '../libs/SBUError';\nimport type { ExpoMediaLibraryPermissionResponse, ExpoPermissionResponse } from '../utils/expoPermissionGranted';\nimport expoPermissionGranted from '../utils/expoPermissionGranted';\nimport fileTypeGuard from '../utils/fileTypeGuard';\nimport type {\n  FilePickerResponse,\n  FileServiceInterface,\n  OpenCameraOptions,\n  OpenDocumentOptions,\n  OpenMediaLibraryOptions,\n  SaveOptions,\n} from './types';\n\nconst createExpoFileService = ({\n  imagePickerModule,\n  documentPickerModule,\n  mediaLibraryModule,\n  fsModule,\n}: {\n  imagePickerModule: typeof ExpoImagePicker;\n  documentPickerModule: typeof ExpoDocumentPicker;\n  mediaLibraryModule: typeof ExpoMediaLibrary;\n  fsModule: typeof ExpoFs;\n}): FileServiceInterface => {\n  class ExpoFileServiceInterface implements FileServiceInterface {\n    async hasCameraPermission(): Promise<boolean> {\n      const res = (await imagePickerModule.getCameraPermissionsAsync()) as ExpoPermissionResponse;\n      return expoPermissionGranted([res]);\n    }\n    async requestCameraPermission(): Promise<boolean> {\n      const res = (await imagePickerModule.requestCameraPermissionsAsync()) as ExpoPermissionResponse;\n      return expoPermissionGranted([res]);\n    }\n    async hasMediaLibraryPermission(type: 'write' | 'read'): Promise<boolean> {\n      const perms = (await mediaLibraryModule.getPermissionsAsync(\n        type === 'write',\n      )) as ExpoMediaLibraryPermissionResponse;\n      return expoPermissionGranted([perms]);\n    }\n    async requestMediaLibraryPermission(type: 'write' | 'read'): Promise<boolean> {\n      const perms = (await mediaLibraryModule.requestPermissionsAsync(\n        type === 'write',\n      )) as ExpoMediaLibraryPermissionResponse;\n      return expoPermissionGranted([perms]);\n    }\n\n    async openCamera(options?: OpenCameraOptions): Promise<FilePickerResponse> {\n      const hasPermission = await this.hasCameraPermission();\n      if (!hasPermission) {\n        const granted = await this.requestCameraPermission();\n        if (!granted) {\n          options?.onOpenFailure?.(SBUError.PERMISSIONS_DENIED);\n          return null;\n        }\n      }\n\n      const response = await imagePickerModule.launchCameraAsync({\n        mediaTypes: (() => {\n          switch (options?.mediaType) {\n            case 'photo':\n              return imagePickerModule.MediaTypeOptions.Images;\n            case 'video':\n              return imagePickerModule.MediaTypeOptions.Videos;\n            case 'all':\n              return imagePickerModule.MediaTypeOptions.All;\n            default:\n              return imagePickerModule.MediaTypeOptions.Images;\n          }\n        })(),\n      });\n\n      if (response.cancelled) return null;\n\n      const { uri } = response;\n      const { size } = await fsModule.getInfoAsync(response.uri);\n      const ext = getFileExtension(uri);\n      const type = getFileType(ext);\n\n      return fileTypeGuard({ uri, size, type: `${type}/${ext.slice(1)}`, name: Date.now() + ext });\n    }\n    async openMediaLibrary(options: OpenMediaLibraryOptions) {\n      const hasPermission = await this.hasMediaLibraryPermission('read');\n      if (!hasPermission) {\n        const granted = await this.requestMediaLibraryPermission('read');\n        if (!granted) {\n          options?.onOpenFailure?.(SBUError.PERMISSIONS_DENIED);\n          return null;\n        }\n      }\n\n      const response = await imagePickerModule.launchImageLibraryAsync({\n        mediaTypes: (() => {\n          switch (options?.mediaType) {\n            case 'photo':\n              return imagePickerModule.MediaTypeOptions.Images;\n            case 'video':\n              return imagePickerModule.MediaTypeOptions.Videos;\n            case 'all':\n              return imagePickerModule.MediaTypeOptions.All;\n            default:\n              return imagePickerModule.MediaTypeOptions.Images;\n          }\n        })(),\n      });\n      if (response.cancelled) return null;\n      const { uri } = response;\n\n      const { size } = await fsModule.getInfoAsync(uri);\n      const ext = getFileExtension(uri);\n      const type = getFileType(ext);\n      return [fileTypeGuard({ uri, size, type: `${type}/${ext.slice(1)}`, name: Date.now() + ext })];\n    }\n\n    async openDocument(options?: OpenDocumentOptions): Promise<FilePickerResponse> {\n      try {\n        const response = await documentPickerModule.getDocumentAsync({ type: '*/*' });\n        if (response.type === 'cancel') return null;\n        const { mimeType, uri, size, name } = response;\n        return fileTypeGuard({ uri, size, name, type: mimeType });\n      } catch (e) {\n        options?.onOpenFailure?.(SBUError.UNKNOWN, e);\n        return null;\n      }\n    }\n\n    async save(options: SaveOptions): Promise<string> {\n      const hasPermission = await this.hasMediaLibraryPermission('write');\n      if (!hasPermission) {\n        const granted = await this.requestMediaLibraryPermission('write');\n        if (!granted) throw new Error('Permission not granted');\n      }\n\n      const basePath = fsModule.documentDirectory || fsModule.cacheDirectory;\n      if (!basePath) throw new Error('Cannot determine directory');\n\n      const downloadPath = `${basePath}/${options.fileName}`;\n\n      const response = await fsModule.downloadAsync(options.fileUrl, downloadPath);\n      if (getFileType(options.fileType || '').match(/video|image/)) {\n        await mediaLibraryModule.saveToLibraryAsync(response.uri);\n      }\n      return response.uri;\n    }\n  }\n\n  return new ExpoFileServiceInterface();\n};\n\nexport default createExpoFileService;\n"],"mappings":"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"}