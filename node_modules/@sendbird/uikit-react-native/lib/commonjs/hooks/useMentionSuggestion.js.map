{"version":3,"names":["useMentionSuggestion","params","text","selection","channel","mentionedUsers","freshChannel","setFreshChannel","useState","useAsyncEffect","refresh","url","mentionManager","currentUser","useSendbirdChat","members","setMembers","timeoutRef","useRef","searchStringRangeRef","start","end","searchLimitedRef","updateSearchStringRange","selectionIndex","searchString","current","getSearchStringRangeInText","updateSearchLimited","mentionCount","mentionLimit","resetRefs","fetchMembers","selectionRanged","selectionContainsMentionedUser","some","it","rangeHelpers","overlaps","range","isTriggered","isValidSearchString","getSearchString","limited","length","config","isSuper","createMemberListQuery","nicknameStartsWithFilter","limit","suggestionLimit","next","then","filter","member","userId","sort","a","b","nickname","localeCompare","toLowerCase","startsWith","slice","useEffect","setTimeout","catch","finally","undefined","debounceMills","clearTimeout","reset","useCallback","searchStringRange","searchLimited"],"sources":["useMentionSuggestion.ts"],"sourcesContent":["import { useCallback, useEffect, useRef, useState } from 'react';\n\nimport type { SendbirdGroupChannel, SendbirdMember, SendbirdUser } from '@sendbird/uikit-utils';\nimport { useAsyncEffect } from '@sendbird/uikit-utils';\n\nimport { useSendbirdChat } from '../hooks/useContext';\nimport type { Range } from '../types';\n\nconst useMentionSuggestion = (params: {\n  text: string;\n  selection: Range;\n  channel: SendbirdGroupChannel;\n  mentionedUsers: { user: SendbirdUser; range: Range }[];\n}) => {\n  const { text, selection, channel, mentionedUsers } = params;\n\n  const [freshChannel, setFreshChannel] = useState(channel);\n\n  useAsyncEffect(async () => {\n    setFreshChannel(await channel.refresh());\n  }, [channel.url]);\n\n  const { mentionManager, currentUser } = useSendbirdChat();\n  const [members, setMembers] = useState<SendbirdMember[]>([]);\n  const timeoutRef = useRef<NodeJS.Timeout>();\n\n  const searchStringRangeRef = useRef<Range>({ start: 0, end: 0 });\n  const searchLimitedRef = useRef(false);\n\n  const updateSearchStringRange = (selectionIndex: number, searchString: string) => {\n    searchStringRangeRef.current = mentionManager.getSearchStringRangeInText(selectionIndex, searchString);\n    return searchStringRangeRef.current;\n  };\n  const updateSearchLimited = (mentionCount: number, mentionLimit: number) => {\n    searchLimitedRef.current = mentionCount >= mentionLimit;\n    return searchLimitedRef.current;\n  };\n  const resetRefs = () => {\n    searchLimitedRef.current = false;\n    searchStringRangeRef.current = { start: 0, end: 0 };\n  };\n\n  const fetchMembers = async (): Promise<SendbirdMember[]> => {\n    resetRefs();\n\n    const selectionRanged = selection.start !== selection.end;\n    if (selectionRanged) return [];\n\n    const selectionContainsMentionedUser = mentionedUsers.some((it) =>\n      mentionManager.rangeHelpers.overlaps(it.range, selection, 'underMore'),\n    );\n    if (selectionContainsMentionedUser) return [];\n\n    const { isTriggered, isValidSearchString, searchString } = mentionManager.getSearchString(text, selection.start);\n    if (!isTriggered() || !isValidSearchString()) return [];\n\n    const limited = updateSearchLimited(mentionedUsers.length, mentionManager.config.mentionLimit);\n    if (limited) return [];\n\n    updateSearchStringRange(selection.start, searchString);\n\n    if (freshChannel.isSuper) {\n      return freshChannel\n        .createMemberListQuery({\n          nicknameStartsWithFilter: searchString,\n          limit: mentionManager.config.suggestionLimit + 1,\n        })\n        .next()\n        .then((members) => members.filter((member) => member.userId !== currentUser?.userId));\n    } else {\n      return freshChannel.members\n        .sort((a, b) => a.nickname?.localeCompare(b.nickname))\n        .filter(\n          (member) =>\n            member.nickname?.toLowerCase().startsWith(searchString.toLowerCase()) &&\n            member.userId !== currentUser?.userId,\n        )\n        .slice(0, mentionManager.config.suggestionLimit);\n    }\n  };\n\n  useEffect(() => {\n    timeoutRef.current = setTimeout(async () => {\n      fetchMembers()\n        .then(setMembers)\n        .catch(() => setMembers([]))\n        .finally(() => (timeoutRef.current = undefined));\n    }, mentionManager.config.debounceMills);\n\n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n        timeoutRef.current = undefined;\n      }\n    };\n  }, [text, selection]);\n\n  return {\n    members,\n    reset: useCallback(() => setMembers([]), []),\n    searchStringRange: searchStringRangeRef.current,\n    searchLimited: searchLimitedRef.current,\n  };\n};\n\nexport default useMentionSuggestion;\n"],"mappings":"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"}