{"version":3,"names":["getFileExtension","getFileType","SBUError","expoPermissionGranted","fileTypeGuard","createExpoFileService","imagePickerModule","documentPickerModule","mediaLibraryModule","fsModule","ExpoFileServiceInterface","hasCameraPermission","res","getCameraPermissionsAsync","requestCameraPermission","requestCameraPermissionsAsync","hasMediaLibraryPermission","type","perms","getPermissionsAsync","requestMediaLibraryPermission","requestPermissionsAsync","openCamera","options","hasPermission","granted","onOpenFailure","PERMISSIONS_DENIED","response","launchCameraAsync","mediaTypes","mediaType","MediaTypeOptions","Images","Videos","All","cancelled","uri","size","getInfoAsync","ext","slice","name","Date","now","openMediaLibrary","launchImageLibraryAsync","openDocument","getDocumentAsync","mimeType","e","UNKNOWN","save","Error","basePath","documentDirectory","cacheDirectory","downloadPath","fileName","downloadAsync","fileUrl","fileType","match","saveToLibraryAsync"],"sources":["createFileService.expo.ts"],"sourcesContent":["import type * as ExpoDocumentPicker from 'expo-document-picker';\nimport type * as ExpoFs from 'expo-file-system';\nimport type * as ExpoImagePicker from 'expo-image-picker';\nimport type * as ExpoMediaLibrary from 'expo-media-library';\n\nimport { getFileExtension, getFileType } from '@sendbird/uikit-utils';\n\nimport SBUError from '../libs/SBUError';\nimport type { ExpoMediaLibraryPermissionResponse, ExpoPermissionResponse } from '../utils/expoPermissionGranted';\nimport expoPermissionGranted from '../utils/expoPermissionGranted';\nimport fileTypeGuard from '../utils/fileTypeGuard';\nimport type {\n  FilePickerResponse,\n  FileServiceInterface,\n  OpenCameraOptions,\n  OpenDocumentOptions,\n  OpenMediaLibraryOptions,\n  SaveOptions,\n} from './types';\n\nconst createExpoFileService = ({\n  imagePickerModule,\n  documentPickerModule,\n  mediaLibraryModule,\n  fsModule,\n}: {\n  imagePickerModule: typeof ExpoImagePicker;\n  documentPickerModule: typeof ExpoDocumentPicker;\n  mediaLibraryModule: typeof ExpoMediaLibrary;\n  fsModule: typeof ExpoFs;\n}): FileServiceInterface => {\n  class ExpoFileServiceInterface implements FileServiceInterface {\n    async hasCameraPermission(): Promise<boolean> {\n      const res = (await imagePickerModule.getCameraPermissionsAsync()) as ExpoPermissionResponse;\n      return expoPermissionGranted([res]);\n    }\n    async requestCameraPermission(): Promise<boolean> {\n      const res = (await imagePickerModule.requestCameraPermissionsAsync()) as ExpoPermissionResponse;\n      return expoPermissionGranted([res]);\n    }\n    async hasMediaLibraryPermission(type: 'write' | 'read'): Promise<boolean> {\n      const perms = (await mediaLibraryModule.getPermissionsAsync(\n        type === 'write',\n      )) as ExpoMediaLibraryPermissionResponse;\n      return expoPermissionGranted([perms]);\n    }\n    async requestMediaLibraryPermission(type: 'write' | 'read'): Promise<boolean> {\n      const perms = (await mediaLibraryModule.requestPermissionsAsync(\n        type === 'write',\n      )) as ExpoMediaLibraryPermissionResponse;\n      return expoPermissionGranted([perms]);\n    }\n\n    async openCamera(options?: OpenCameraOptions): Promise<FilePickerResponse> {\n      const hasPermission = await this.hasCameraPermission();\n      if (!hasPermission) {\n        const granted = await this.requestCameraPermission();\n        if (!granted) {\n          options?.onOpenFailure?.(SBUError.PERMISSIONS_DENIED);\n          return null;\n        }\n      }\n\n      const response = await imagePickerModule.launchCameraAsync({\n        mediaTypes: (() => {\n          switch (options?.mediaType) {\n            case 'photo':\n              return imagePickerModule.MediaTypeOptions.Images;\n            case 'video':\n              return imagePickerModule.MediaTypeOptions.Videos;\n            case 'all':\n              return imagePickerModule.MediaTypeOptions.All;\n            default:\n              return imagePickerModule.MediaTypeOptions.Images;\n          }\n        })(),\n      });\n\n      if (response.cancelled) return null;\n\n      const { uri } = response;\n      const { size } = await fsModule.getInfoAsync(response.uri);\n      const ext = getFileExtension(uri);\n      const type = getFileType(ext);\n\n      return fileTypeGuard({ uri, size, type: `${type}/${ext.slice(1)}`, name: Date.now() + ext });\n    }\n    async openMediaLibrary(options: OpenMediaLibraryOptions) {\n      const hasPermission = await this.hasMediaLibraryPermission('read');\n      if (!hasPermission) {\n        const granted = await this.requestMediaLibraryPermission('read');\n        if (!granted) {\n          options?.onOpenFailure?.(SBUError.PERMISSIONS_DENIED);\n          return null;\n        }\n      }\n\n      const response = await imagePickerModule.launchImageLibraryAsync({\n        mediaTypes: (() => {\n          switch (options?.mediaType) {\n            case 'photo':\n              return imagePickerModule.MediaTypeOptions.Images;\n            case 'video':\n              return imagePickerModule.MediaTypeOptions.Videos;\n            case 'all':\n              return imagePickerModule.MediaTypeOptions.All;\n            default:\n              return imagePickerModule.MediaTypeOptions.Images;\n          }\n        })(),\n      });\n      if (response.cancelled) return null;\n      const { uri } = response;\n\n      const { size } = await fsModule.getInfoAsync(uri);\n      const ext = getFileExtension(uri);\n      const type = getFileType(ext);\n      return [fileTypeGuard({ uri, size, type: `${type}/${ext.slice(1)}`, name: Date.now() + ext })];\n    }\n\n    async openDocument(options?: OpenDocumentOptions): Promise<FilePickerResponse> {\n      try {\n        const response = await documentPickerModule.getDocumentAsync({ type: '*/*' });\n        if (response.type === 'cancel') return null;\n        const { mimeType, uri, size, name } = response;\n        return fileTypeGuard({ uri, size, name, type: mimeType });\n      } catch (e) {\n        options?.onOpenFailure?.(SBUError.UNKNOWN, e);\n        return null;\n      }\n    }\n\n    async save(options: SaveOptions): Promise<string> {\n      const hasPermission = await this.hasMediaLibraryPermission('write');\n      if (!hasPermission) {\n        const granted = await this.requestMediaLibraryPermission('write');\n        if (!granted) throw new Error('Permission not granted');\n      }\n\n      const basePath = fsModule.documentDirectory || fsModule.cacheDirectory;\n      if (!basePath) throw new Error('Cannot determine directory');\n\n      const downloadPath = `${basePath}/${options.fileName}`;\n\n      const response = await fsModule.downloadAsync(options.fileUrl, downloadPath);\n      if (getFileType(options.fileType || '').match(/video|image/)) {\n        await mediaLibraryModule.saveToLibraryAsync(response.uri);\n      }\n      return response.uri;\n    }\n  }\n\n  return new ExpoFileServiceInterface();\n};\n\nexport default createExpoFileService;\n"],"mappings":"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"}