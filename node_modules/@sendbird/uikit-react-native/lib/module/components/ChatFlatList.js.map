{"version":3,"names":["React","forwardRef","useCallback","useEffect","useImperativeHandle","useRef","FlatList","Platform","useUIKitTheme","getMessageUniqId","isMyMessage","ANDROID_BUG_ALERT_SHOWED","OS","BOTTOM_DETECT_THRESHOLD","hasReachedToBottom","yPos","thresholdPx","ChatFlatList","CustomFlatList","ref","onTopReached","nextMessages","onBottomReached","onLeaveScrollBottom","onScroll","currentUserId","props","select","scrollRef","scrollToBottom","animated","current","scrollToOffset","offset","latestMessage","length","_onScroll","event","contentOffset","nativeEvent","y","__DEV__","console","warn","light","dark","Boolean","data"],"sources":["ChatFlatList.tsx"],"sourcesContent":["import React, { forwardRef, useCallback, useEffect, useImperativeHandle, useRef } from 'react';\nimport { FlatList, FlatListProps, Platform } from 'react-native';\n\nimport { useUIKitTheme } from '@sendbird/uikit-react-native-foundation';\nimport { SendbirdMessage, getMessageUniqId, isMyMessage } from '@sendbird/uikit-utils';\n\nlet ANDROID_BUG_ALERT_SHOWED = Platform.OS !== 'android';\nconst BOTTOM_DETECT_THRESHOLD = 25;\n// const AUTO_SCROLL_TO_TOP_THRESHOLD = 15;\n\nfunction hasReachedToBottom(yPos: number, thresholdPx = 0) {\n  return thresholdPx >= yPos;\n}\n\nexport type ChatFlatListRef = { scrollToBottom: (animated?: boolean) => void };\ntype Props = Omit<FlatListProps<SendbirdMessage>, 'onEndReached'> & {\n  currentUserId?: string;\n  onBottomReached: () => void;\n  onTopReached: () => void;\n  nextMessages: SendbirdMessage[];\n  onLeaveScrollBottom: (value: boolean) => void;\n};\n// FIXME: Inverted FlatList performance issue on Android {@link https://github.com/facebook/react-native/issues/30034}\nconst ChatFlatList = forwardRef<ChatFlatListRef, Props>(function CustomFlatList(\n  { onTopReached, nextMessages, onBottomReached, onLeaveScrollBottom, onScroll, currentUserId, ...props },\n  ref,\n) {\n  const { select } = useUIKitTheme();\n  const scrollRef = useRef<FlatList<SendbirdMessage>>(null);\n  const yPos = useRef(0);\n\n  useImperativeHandle(\n    ref,\n    () => ({\n      scrollToBottom: (animated = true) => scrollRef.current?.scrollToOffset({ animated, offset: 0 }),\n    }),\n    [],\n  );\n\n  useEffect(() => {\n    const latestMessage = nextMessages[nextMessages.length - 1];\n    if (!latestMessage) return;\n\n    if (hasReachedToBottom(yPos.current)) {\n      onBottomReached();\n    } else if (isMyMessage(latestMessage, currentUserId)) {\n      scrollRef.current?.scrollToOffset({ animated: false, offset: 0 });\n    }\n  }, [onBottomReached, nextMessages, currentUserId]);\n\n  const _onScroll = useCallback<NonNullable<Props['onScroll']>>(\n    (event) => {\n      const { contentOffset } = event.nativeEvent;\n      if (BOTTOM_DETECT_THRESHOLD < yPos.current && contentOffset.y <= BOTTOM_DETECT_THRESHOLD) {\n        onLeaveScrollBottom(false);\n      } else if (BOTTOM_DETECT_THRESHOLD < contentOffset.y && yPos.current <= BOTTOM_DETECT_THRESHOLD) {\n        onLeaveScrollBottom(true);\n      }\n\n      yPos.current = contentOffset.y;\n\n      onScroll?.(event);\n      if (hasReachedToBottom(yPos.current)) onBottomReached();\n    },\n    [onScroll, onBottomReached],\n  );\n\n  if (__DEV__ && !ANDROID_BUG_ALERT_SHOWED) {\n    ANDROID_BUG_ALERT_SHOWED = true;\n    // eslint-disable-next-line no-console\n    console.warn(\n      'UIKit Warning: Inverted FlatList has a performance issue on Android, Maybe this is a bug please refer link\\nhttps://github.com/facebook/react-native/issues/30034',\n    );\n  }\n\n  return (\n    <FlatList\n      bounces={false}\n      removeClippedSubviews\n      keyboardDismissMode={'on-drag'}\n      keyboardShouldPersistTaps={'handled'}\n      indicatorStyle={select({ light: 'black', dark: 'white' })}\n      {...props}\n      // FIXME: inverted list of ListEmptyComponent is reversed {@link https://github.com/facebook/react-native/issues/21196#issuecomment-836937743}\n      inverted={Boolean(props.data?.length)}\n      // FIXME: maintainVisibleContentPosition is not working on Android {@link https://github.com/facebook/react-native/issues/25239}\n      // maintainVisibleContentPosition={{ minIndexForVisible: 1, autoscrollToTopThreshold: AUTO_SCROLL_TO_TOP_THRESHOLD }}\n      ref={scrollRef}\n      onEndReachedThreshold={0.5}\n      onEndReached={onTopReached}\n      scrollEventThrottle={16}\n      onScroll={_onScroll}\n      keyExtractor={getMessageUniqId}\n    />\n  );\n});\n\nexport default ChatFlatList;\n"],"mappings":"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"}