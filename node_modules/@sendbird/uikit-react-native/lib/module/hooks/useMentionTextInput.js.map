{"version":3,"names":["useEffect","useRef","useState","Platform","replace","useFreshCallback","useSendbirdChat","useMentionTextInput","params","mentionManager","mentionedUsersRef","textInputRef","text","setText","selection","setSelection","start","end","shouldUseMentionedMessageTemplate","messageToEdit","result","templateToTextAndMentionedUsers","mentionedMessageTemplate","mentionedUsers","current","mentionedText","isUserMessage","message","onChangeText","_nextText","addedMentionedUser","prevText","nextText","offset","length","push","reconcileRangeOfMentionedUsers","filtered","lastSelection","removeMentionedUsersInSelection","Math","max","foundIndex","findIndex","it","rangeHelpers","overlaps","range","remainderLength","splice","onSelectionChange","e","nativeSelection","nativeEvent","setTimeout","mentionedUser","find","selectionBlock","setNativeProps","OS"],"sources":["useMentionTextInput.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport type { NativeSyntheticEvent, TextInput, TextInputSelectionChangeEventData } from 'react-native';\nimport { Platform } from 'react-native';\n\nimport { SendbirdFileMessage, SendbirdUserMessage, replace, useFreshCallback } from '@sendbird/uikit-utils';\n\nimport type { MentionedUser } from '../types';\nimport { useSendbirdChat } from './useContext';\n\nconst useMentionTextInput = (params: { messageToEdit?: SendbirdUserMessage | SendbirdFileMessage }) => {\n  const { mentionManager } = useSendbirdChat();\n\n  const mentionedUsersRef = useRef<MentionedUser[]>([]);\n  const textInputRef = useRef<TextInput>();\n\n  const [text, setText] = useState('');\n  const [selection, setSelection] = useState({ start: 0, end: 0 });\n\n  // TODO: Refactor text edit logic more clearly\n  useEffect(() => {\n    if (mentionManager.shouldUseMentionedMessageTemplate(params.messageToEdit)) {\n      const result = mentionManager.templateToTextAndMentionedUsers(\n        params.messageToEdit.mentionedMessageTemplate,\n        params.messageToEdit.mentionedUsers,\n      );\n\n      mentionedUsersRef.current = result.mentionedUsers;\n      setText(result.mentionedText);\n    } else {\n      mentionedUsersRef.current = [];\n      if (params.messageToEdit?.isUserMessage()) {\n        setText(params.messageToEdit.message);\n      }\n    }\n  }, [params.messageToEdit]);\n\n  const onChangeText = useFreshCallback((_nextText: string, addedMentionedUser?: MentionedUser) => {\n    const prevText = text;\n    let nextText = _nextText;\n    let offset = nextText.length - prevText.length;\n\n    // Text clear\n    if (nextText === '') {\n      mentionedUsersRef.current = [];\n    }\n    // Text add\n    else if (offset > 0) {\n      /** Add mentioned user **/\n      if (addedMentionedUser) mentionedUsersRef.current.push(addedMentionedUser);\n\n      /** Reconcile mentioned users range on the right side of the selection **/\n      mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n        offset,\n        selection.end,\n        mentionedUsersRef.current,\n      );\n    }\n    // Text remove\n    else if (offset < 0) {\n      // Ranged remove\n      if (selection.start !== selection.end) {\n        /** Filter mentioned users in selection range **/\n        const { filtered, lastSelection } = mentionManager.removeMentionedUsersInSelection(\n          selection,\n          mentionedUsersRef.current,\n        );\n\n        /** Reconcile mentioned users range on the right side of the selection **/\n        mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n          offset,\n          Math.max(selection.end, lastSelection),\n          filtered,\n        );\n      }\n      // Single remove\n      else {\n        /** Find mentioned user who ranges in removed selection **/\n        const foundIndex = mentionedUsersRef.current.findIndex((it) =>\n          mentionManager.rangeHelpers.overlaps(it.range, selection, 'underMore'),\n        );\n        /** If found, remove from the mentioned user list and remove remainder text **/\n        if (foundIndex > -1) {\n          const it = mentionedUsersRef.current[foundIndex];\n          const remainderLength = it.range.end - it.range.start + offset;\n\n          offset = -remainderLength + offset;\n          nextText = replace(nextText, it.range.start, it.range.start + remainderLength, '');\n\n          mentionedUsersRef.current.splice(foundIndex, 1);\n        }\n\n        /** Reconcile mentioned users range on the right side of the selection **/\n        mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n          offset,\n          selection.end,\n          mentionedUsersRef.current,\n        );\n      }\n    }\n\n    setText(nextText);\n  });\n\n  return {\n    textInputRef,\n    selection,\n    onSelectionChange: useFreshCallback((e: NativeSyntheticEvent<TextInputSelectionChangeEventData>) => {\n      const nativeSelection = { ...e.nativeEvent.selection };\n\n      // NOTE: To synchronize call onSelectionChange after onChangeText called on each platform.\n      setTimeout(() => {\n        const mentionedUser = mentionedUsersRef.current.find((it) =>\n          mentionManager.rangeHelpers.overlaps(it.range, nativeSelection),\n        );\n\n        // Selection should be blocked if changed into mentioned area\n        if (mentionedUser) {\n          const selectionBlock = { start: mentionedUser.range.start, end: mentionedUser.range.end };\n          textInputRef.current?.setNativeProps({ selection: selectionBlock });\n          // BUG: setNativeProps called again when invoked onChangeText\n          //  https://github.com/facebook/react-native/issues/33520\n          if (Platform.OS === 'android') {\n            setTimeout(() => {\n              textInputRef.current?.setNativeProps({ selection: { start: 0 } });\n            }, 250);\n          }\n          setSelection(selectionBlock);\n        } else {\n          setSelection(nativeSelection);\n        }\n      }, 10);\n    }),\n    text,\n    onChangeText,\n    mentionedUsers: mentionedUsersRef.current,\n  };\n};\n\nexport default useMentionTextInput;\n"],"mappings":"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"}