{"version":3,"names":["useCallback","useEffect","useRef","useState","useAsyncEffect","useSendbirdChat","useMentionSuggestion","params","text","selection","channel","mentionedUsers","freshChannel","setFreshChannel","refresh","url","mentionManager","currentUser","members","setMembers","timeoutRef","searchStringRangeRef","start","end","searchLimitedRef","updateSearchStringRange","selectionIndex","searchString","current","getSearchStringRangeInText","updateSearchLimited","mentionCount","mentionLimit","resetRefs","fetchMembers","selectionRanged","selectionContainsMentionedUser","some","it","rangeHelpers","overlaps","range","isTriggered","isValidSearchString","getSearchString","limited","length","config","isSuper","createMemberListQuery","nicknameStartsWithFilter","limit","suggestionLimit","next","then","filter","member","userId","sort","a","b","nickname","localeCompare","toLowerCase","startsWith","slice","setTimeout","catch","finally","undefined","debounceMills","clearTimeout","reset","searchStringRange","searchLimited"],"sources":["useMentionSuggestion.ts"],"sourcesContent":["import { useCallback, useEffect, useRef, useState } from 'react';\n\nimport type { SendbirdGroupChannel, SendbirdMember, SendbirdUser } from '@sendbird/uikit-utils';\nimport { useAsyncEffect } from '@sendbird/uikit-utils';\n\nimport { useSendbirdChat } from '../hooks/useContext';\nimport type { Range } from '../types';\n\nconst useMentionSuggestion = (params: {\n  text: string;\n  selection: Range;\n  channel: SendbirdGroupChannel;\n  mentionedUsers: { user: SendbirdUser; range: Range }[];\n}) => {\n  const { text, selection, channel, mentionedUsers } = params;\n\n  const [freshChannel, setFreshChannel] = useState(channel);\n\n  useAsyncEffect(async () => {\n    setFreshChannel(await channel.refresh());\n  }, [channel.url]);\n\n  const { mentionManager, currentUser } = useSendbirdChat();\n  const [members, setMembers] = useState<SendbirdMember[]>([]);\n  const timeoutRef = useRef<NodeJS.Timeout>();\n\n  const searchStringRangeRef = useRef<Range>({ start: 0, end: 0 });\n  const searchLimitedRef = useRef(false);\n\n  const updateSearchStringRange = (selectionIndex: number, searchString: string) => {\n    searchStringRangeRef.current = mentionManager.getSearchStringRangeInText(selectionIndex, searchString);\n    return searchStringRangeRef.current;\n  };\n  const updateSearchLimited = (mentionCount: number, mentionLimit: number) => {\n    searchLimitedRef.current = mentionCount >= mentionLimit;\n    return searchLimitedRef.current;\n  };\n  const resetRefs = () => {\n    searchLimitedRef.current = false;\n    searchStringRangeRef.current = { start: 0, end: 0 };\n  };\n\n  const fetchMembers = async (): Promise<SendbirdMember[]> => {\n    resetRefs();\n\n    const selectionRanged = selection.start !== selection.end;\n    if (selectionRanged) return [];\n\n    const selectionContainsMentionedUser = mentionedUsers.some((it) =>\n      mentionManager.rangeHelpers.overlaps(it.range, selection, 'underMore'),\n    );\n    if (selectionContainsMentionedUser) return [];\n\n    const { isTriggered, isValidSearchString, searchString } = mentionManager.getSearchString(text, selection.start);\n    if (!isTriggered() || !isValidSearchString()) return [];\n\n    const limited = updateSearchLimited(mentionedUsers.length, mentionManager.config.mentionLimit);\n    if (limited) return [];\n\n    updateSearchStringRange(selection.start, searchString);\n\n    if (freshChannel.isSuper) {\n      return freshChannel\n        .createMemberListQuery({\n          nicknameStartsWithFilter: searchString,\n          limit: mentionManager.config.suggestionLimit + 1,\n        })\n        .next()\n        .then((members) => members.filter((member) => member.userId !== currentUser?.userId));\n    } else {\n      return freshChannel.members\n        .sort((a, b) => a.nickname?.localeCompare(b.nickname))\n        .filter(\n          (member) =>\n            member.nickname?.toLowerCase().startsWith(searchString.toLowerCase()) &&\n            member.userId !== currentUser?.userId,\n        )\n        .slice(0, mentionManager.config.suggestionLimit);\n    }\n  };\n\n  useEffect(() => {\n    timeoutRef.current = setTimeout(async () => {\n      fetchMembers()\n        .then(setMembers)\n        .catch(() => setMembers([]))\n        .finally(() => (timeoutRef.current = undefined));\n    }, mentionManager.config.debounceMills);\n\n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n        timeoutRef.current = undefined;\n      }\n    };\n  }, [text, selection]);\n\n  return {\n    members,\n    reset: useCallback(() => setMembers([]), []),\n    searchStringRange: searchStringRangeRef.current,\n    searchLimited: searchLimitedRef.current,\n  };\n};\n\nexport default useMentionSuggestion;\n"],"mappings":"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"}