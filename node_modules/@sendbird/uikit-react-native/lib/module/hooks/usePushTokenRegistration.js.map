{"version":3,"names":["useRef","Platform","Logger","useFreshCallback","useIIFE","usePlatformService","useSendbirdChat","usePushTokenRegistration","sdk","notificationService","refreshListener","registerToken","unregisterToken","getToken","select","ios","token","registerAPNSPushTokenForCurrentUser","default","registerFCMPushTokenForCurrentUser","unregisterAPNSPushTokenForCurrentUser","unregisterFCMPushTokenForCurrentUser","getAPNSToken","getFCMToken","registerPushTokenForCurrentUser","hasPermission","hasPushPermission","pushPermission","requestPushPermission","warn","log","current","onTokenRefresh","unregisterPushTokenForCurrentUser"],"sources":["usePushTokenRegistration.ts"],"sourcesContent":["import { useRef } from 'react';\nimport { Platform } from 'react-native';\n\nimport { Logger, useFreshCallback, useIIFE } from '@sendbird/uikit-utils';\n\nimport { usePlatformService, useSendbirdChat } from './useContext';\n\nconst usePushTokenRegistration = () => {\n  const { sdk } = useSendbirdChat();\n  const { notificationService } = usePlatformService();\n\n  const refreshListener = useRef<() => void>();\n  const [registerToken, unregisterToken, getToken] = useIIFE(() => {\n    return [\n      Platform.select({\n        ios: (token: string) => sdk.registerAPNSPushTokenForCurrentUser(token),\n        default: (token: string) => sdk.registerFCMPushTokenForCurrentUser(token),\n      }),\n      Platform.select({\n        ios: (token: string) => sdk.unregisterAPNSPushTokenForCurrentUser(token),\n        default: (token: string) => sdk.unregisterFCMPushTokenForCurrentUser(token),\n      }),\n      Platform.select({\n        ios: notificationService.getAPNSToken,\n        default: notificationService.getFCMToken,\n      }),\n    ];\n  });\n\n  const registerPushTokenForCurrentUser = useFreshCallback(async () => {\n    // Check and request push permission\n    const hasPermission = await notificationService.hasPushPermission();\n    if (!hasPermission) {\n      const pushPermission = await notificationService.requestPushPermission();\n      if (!pushPermission) {\n        Logger.warn('[usePushTokenRegistration]', 'Not granted push permission');\n        return;\n      }\n    }\n\n    // Register device token\n    const token = await getToken();\n    if (token) {\n      Logger.log('[usePushTokenRegistration]', 'registered token:', token);\n      registerToken(token);\n    }\n\n    // Remove listener\n    refreshListener.current = notificationService.onTokenRefresh(registerToken);\n  });\n\n  const unregisterPushTokenForCurrentUser = useFreshCallback(async () => {\n    const token = await getToken();\n    if (token) {\n      unregisterToken(token);\n      Logger.log('[usePushTokenRegistration]', 'unregistered token:', token);\n    }\n    refreshListener.current?.();\n  });\n\n  return { registerPushTokenForCurrentUser, unregisterPushTokenForCurrentUser };\n};\n\nexport default usePushTokenRegistration;\n"],"mappings":"AAAA,SAASA,MAAT,QAAuB,OAAvB;AACA,SAASC,QAAT,QAAyB,cAAzB;AAEA,SAASC,MAAT,EAAiBC,gBAAjB,EAAmCC,OAAnC,QAAkD,uBAAlD;AAEA,SAASC,kBAAT,EAA6BC,eAA7B,QAAoD,cAApD;;AAEA,MAAMC,wBAAwB,GAAG,MAAM;EACrC,MAAM;IAAEC;EAAF,IAAUF,eAAe,EAA/B;EACA,MAAM;IAAEG;EAAF,IAA0BJ,kBAAkB,EAAlD;EAEA,MAAMK,eAAe,GAAGV,MAAM,EAA9B;EACA,MAAM,CAACW,aAAD,EAAgBC,eAAhB,EAAiCC,QAAjC,IAA6CT,OAAO,CAAC,MAAM;IAC/D,OAAO,CACLH,QAAQ,CAACa,MAAT,CAAgB;MACdC,GAAG,EAAGC,KAAD,IAAmBR,GAAG,CAACS,mCAAJ,CAAwCD,KAAxC,CADV;MAEdE,OAAO,EAAGF,KAAD,IAAmBR,GAAG,CAACW,kCAAJ,CAAuCH,KAAvC;IAFd,CAAhB,CADK,EAKLf,QAAQ,CAACa,MAAT,CAAgB;MACdC,GAAG,EAAGC,KAAD,IAAmBR,GAAG,CAACY,qCAAJ,CAA0CJ,KAA1C,CADV;MAEdE,OAAO,EAAGF,KAAD,IAAmBR,GAAG,CAACa,oCAAJ,CAAyCL,KAAzC;IAFd,CAAhB,CALK,EASLf,QAAQ,CAACa,MAAT,CAAgB;MACdC,GAAG,EAAEN,mBAAmB,CAACa,YADX;MAEdJ,OAAO,EAAET,mBAAmB,CAACc;IAFf,CAAhB,CATK,CAAP;EAcD,CAfyD,CAA1D;EAiBA,MAAMC,+BAA+B,GAAGrB,gBAAgB,CAAC,YAAY;IACnE;IACA,MAAMsB,aAAa,GAAG,MAAMhB,mBAAmB,CAACiB,iBAApB,EAA5B;;IACA,IAAI,CAACD,aAAL,EAAoB;MAClB,MAAME,cAAc,GAAG,MAAMlB,mBAAmB,CAACmB,qBAApB,EAA7B;;MACA,IAAI,CAACD,cAAL,EAAqB;QACnBzB,MAAM,CAAC2B,IAAP,CAAY,4BAAZ,EAA0C,6BAA1C;QACA;MACD;IACF,CATkE,CAWnE;;;IACA,MAAMb,KAAK,GAAG,MAAMH,QAAQ,EAA5B;;IACA,IAAIG,KAAJ,EAAW;MACTd,MAAM,CAAC4B,GAAP,CAAW,4BAAX,EAAyC,mBAAzC,EAA8Dd,KAA9D;MACAL,aAAa,CAACK,KAAD,CAAb;IACD,CAhBkE,CAkBnE;;;IACAN,eAAe,CAACqB,OAAhB,GAA0BtB,mBAAmB,CAACuB,cAApB,CAAmCrB,aAAnC,CAA1B;EACD,CApBuD,CAAxD;EAsBA,MAAMsB,iCAAiC,GAAG9B,gBAAgB,CAAC,YAAY;IAAA;;IACrE,MAAMa,KAAK,GAAG,MAAMH,QAAQ,EAA5B;;IACA,IAAIG,KAAJ,EAAW;MACTJ,eAAe,CAACI,KAAD,CAAf;MACAd,MAAM,CAAC4B,GAAP,CAAW,4BAAX,EAAyC,qBAAzC,EAAgEd,KAAhE;IACD;;IACD,yBAAAN,eAAe,CAACqB,OAAhB,qFAAArB,eAAe;EAChB,CAPyD,CAA1D;EASA,OAAO;IAAEc,+BAAF;IAAmCS;EAAnC,CAAP;AACD,CAtDD;;AAwDA,eAAe1B,wBAAf"}