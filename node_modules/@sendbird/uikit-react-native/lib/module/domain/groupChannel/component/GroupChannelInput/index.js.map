{"version":3,"names":["React","useContext","useEffect","useRef","useState","KeyboardAvoidingView","Platform","View","useSafeAreaInsets","createStyleSheet","useUIKitTheme","getGroupChannelChatAvailableState","replace","useIIFE","useSendbirdChat","useMentionTextInput","GroupChannelContexts","EditInput","SendInput","AUTO_FOCUS","select","ios","android","default","KEYBOARD_AVOID_VIEW_BEHAVIOR","undefined","GET_INPUT_KEY","shouldReset","GroupChannelInput","props","top","left","right","bottom","colors","features","mentionManager","channel","messageToEdit","setMessageToEdit","keyboardAvoidOffset","Fragment","chatAvailableState","mentionAvailable","userMentionEnabled","isGroupChannel","isBroadcast","inputMode","isFileMessage","inputHeight","setInputHeight","styles","inputDefault","height","selection","onSelectionChange","textInputRef","text","onChangeText","mentionedUsers","useTypingTrigger","useTextPersistenceOnDisabled","disabled","useAutoFocusOnEditMode","onPressToMention","user","searchStringRange","mentionedMessageText","asMentionedMessageText","range","start","end","length","shouldRenderInput","paddingLeft","paddingRight","backgroundColor","background","e","nativeEvent","layout","inputContainer","endTyping","startTyping","setText","chatDisabled","textTmpRef","current","isUserMessage","setTimeout","focus","SafeAreaBottom","justifyContent","width","memo"],"sources":["index.tsx"],"sourcesContent":["import React, { MutableRefObject, useContext, useEffect, useRef, useState } from 'react';\nimport { KeyboardAvoidingView, Platform, TextInput, View } from 'react-native';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\n\nimport { createStyleSheet, useUIKitTheme } from '@sendbird/uikit-react-native-foundation';\nimport {\n  SendbirdFileMessage,\n  SendbirdGroupChannel,\n  SendbirdUserMessage,\n  getGroupChannelChatAvailableState,\n  replace,\n  useIIFE,\n} from '@sendbird/uikit-utils';\n\nimport { useSendbirdChat } from '../../../../hooks/useContext';\nimport useMentionTextInput from '../../../../hooks/useMentionTextInput';\nimport { GroupChannelContexts } from '../../module/moduleContext';\nimport type { GroupChannelProps } from '../../types';\nimport EditInput from './EditInput';\nimport SendInput from './SendInput';\n\nconst AUTO_FOCUS = Platform.select({ ios: false, android: true, default: false });\nconst KEYBOARD_AVOID_VIEW_BEHAVIOR = Platform.select({ ios: 'padding' as const, default: undefined });\n\n// FIXME(iOS): Dynamic style does not work properly when typing the CJK. (https://github.com/facebook/react-native/issues/26107)\n//  To workaround temporarily, change the key for re-mount the component.\n//  -> This will affect to keyboard blur when add/remove first mentioned user.\nconst GET_INPUT_KEY = (shouldReset: boolean) => (shouldReset ? 'uikit-input-clear' : 'uikit-input');\n\n// TODO: Refactor 'Edit' mode to clearly\nconst GroupChannelInput = (props: GroupChannelProps['Input']) => {\n  const { top, left, right, bottom } = useSafeAreaInsets();\n  const { colors } = useUIKitTheme();\n  const { features, mentionManager } = useSendbirdChat();\n  const {\n    channel,\n    messageToEdit,\n    setMessageToEdit,\n    keyboardAvoidOffset = 0,\n  } = useContext(GroupChannelContexts.Fragment);\n\n  const chatAvailableState = getGroupChannelChatAvailableState(channel);\n  const mentionAvailable = features.userMentionEnabled && channel.isGroupChannel() && !channel.isBroadcast;\n  const inputMode = useIIFE(() => {\n    if (!messageToEdit) return 'send';\n    if (messageToEdit.isFileMessage()) return 'send';\n    return 'edit';\n  });\n\n  const [inputHeight, setInputHeight] = useState(styles.inputDefault.height);\n\n  const { selection, onSelectionChange, textInputRef, text, onChangeText, mentionedUsers } = useMentionTextInput({\n    messageToEdit: messageToEdit,\n  });\n\n  useTypingTrigger(text, channel);\n  useTextPersistenceOnDisabled(text, onChangeText, chatAvailableState.disabled);\n  useAutoFocusOnEditMode(textInputRef, messageToEdit);\n\n  const onPressToMention: GroupChannelProps['SuggestedMentionList']['onPressToMention'] = (user, searchStringRange) => {\n    const mentionedMessageText = mentionManager.asMentionedMessageText(user, true);\n    const range = { start: searchStringRange.start, end: searchStringRange.start + mentionedMessageText.length - 1 };\n\n    onChangeText(replace(text, searchStringRange.start, searchStringRange.end, mentionedMessageText), { user, range });\n  };\n\n  if (!props.shouldRenderInput) {\n    return <SafeAreaBottom height={bottom} />;\n  }\n\n  return (\n    <>\n      <KeyboardAvoidingView\n        keyboardVerticalOffset={-bottom + keyboardAvoidOffset}\n        behavior={KEYBOARD_AVOID_VIEW_BEHAVIOR}\n      >\n        <View style={{ paddingLeft: left, paddingRight: right, backgroundColor: colors.background }}>\n          <View onLayout={(e) => setInputHeight(e.nativeEvent.layout.height)} style={styles.inputContainer}>\n            {inputMode === 'send' && (\n              <SendInput\n                {...props}\n                {...chatAvailableState}\n                key={GET_INPUT_KEY(mentionedUsers.length === 0)}\n                ref={textInputRef as never}\n                text={text}\n                onChangeText={onChangeText}\n                onSelectionChange={onSelectionChange}\n                mentionedUsers={mentionedUsers}\n              />\n            )}\n            {inputMode === 'edit' && messageToEdit && (\n              <EditInput\n                {...props}\n                key={GET_INPUT_KEY(mentionedUsers.length === 0)}\n                ref={textInputRef as never}\n                autoFocus={AUTO_FOCUS}\n                text={text}\n                onChangeText={onChangeText}\n                messageToEdit={messageToEdit}\n                setMessageToEdit={setMessageToEdit}\n                disabled={chatAvailableState.disabled}\n                onSelectionChange={onSelectionChange}\n                mentionedUsers={mentionedUsers}\n              />\n            )}\n          </View>\n          <SafeAreaBottom height={bottom} />\n        </View>\n      </KeyboardAvoidingView>\n      {mentionAvailable && (\n        <props.SuggestedMentionList\n          text={text}\n          selection={selection}\n          inputHeight={inputHeight}\n          topInset={top}\n          bottomInset={bottom}\n          onPressToMention={onPressToMention}\n          mentionedUsers={mentionedUsers}\n        />\n      )}\n    </>\n  );\n};\n\nconst useTypingTrigger = (text: string, channel: SendbirdGroupChannel) => {\n  useEffect(() => {\n    if (text.length === 0) channel.endTyping();\n    else channel.startTyping();\n  }, [text]);\n};\n\nconst useTextPersistenceOnDisabled = (text: string, setText: (val: string) => void, chatDisabled: boolean) => {\n  const textTmpRef = useRef('');\n\n  useEffect(() => {\n    if (chatDisabled) {\n      textTmpRef.current = text;\n      setText('');\n    } else {\n      setText(textTmpRef.current);\n    }\n  }, [chatDisabled]);\n};\n\nconst useAutoFocusOnEditMode = (\n  textInputRef: MutableRefObject<TextInput | undefined>,\n  messageToEdit?: SendbirdUserMessage | SendbirdFileMessage,\n) => {\n  useEffect(() => {\n    if (messageToEdit?.isUserMessage()) {\n      if (!AUTO_FOCUS) setTimeout(() => textInputRef.current?.focus(), 500);\n    }\n  }, [messageToEdit]);\n};\n\nconst SafeAreaBottom = ({ height }: { height: number }) => {\n  return <View style={{ height }} />;\n};\n\nconst styles = createStyleSheet({\n  inputContainer: {\n    justifyContent: 'center',\n    width: '100%',\n  },\n  inputDefault: {\n    height: 56,\n  },\n});\n\nexport default React.memo(GroupChannelInput);\n"],"mappings":"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"}